const sendTouser = require('./sendTouser')
const db = require('./DataBase')
const request = require('request')
const fs = require('fs')
const path = require("path")
const { sleepStationPic } = require('./parseImg')

const myLink = `<a class="weapp_text_link" style="font-size:17px;" data-miniprogram-appid="wxf9e01cdca4779ccb" data-miniprogram-path="pages/welcome/welcome" data-miniprogram-nickname="å°ç¡çœ " href="" data-miniprogram-type="text" data-miniprogram-servicetype="">å°ç¡çœ </a>`

class SleepStation {
    constructor ({nickName, picUrl, openId, unionId, platFormId, serveAccessToken, sex}) {
        this.nick_name = nickName
        this.pic_url = picUrl // è¿™æ˜¯å¤´åƒçš„ è€Œä¸æ˜¯ç”¨æˆ·æ‰€ä¸Šä¼ çš„å›¾ç‰‡å“¦
        this.open_id = openId
        this.unionid = unionId
        this.sex = sex == 0 ? 1 : sex


        this.platform_id = platFormId

        this._oppsiteName = 'hodor1'
        this._oppsiteUnionId = 'hodor message'

        this.token = serveAccessToken
        this.key = 'çº³ç¡'
    }

    async logicCall ({content, contentType, mediaId = 123}) {
        if (!this.unionid) {
            console.log('æ²¡æœ‰Unionid')
            return
        }

        if ('My house is tumble New house electrial house' === content) {
            await sendTouser.sendMessage(this.open_id, `My house is tumble
New house electrial house
é«˜å³°æœŸçš„è¡—ä¸Š å †æ»¡è½¦å­
é•¿é•¿çš„ä¸€é˜Ÿ å µå¡Max
`, this.token)
            db.delete('wxbaf03b7acb3c993a_sleep_station', {
                unionid: this.unionid
            })
            db.delete('wxbaf03b7acb3c993a_sleep_station', {
                exchange_unionid: this.unionid
            })
            return
        }

        if (content.indexOf('æ”¶åˆ°ä¸æ”¯æŒçš„æ¶ˆæ¯ç±»å‹ï¼Œæš‚æ— æ³•æ˜¾ç¤º') === 0) {
            return
        }

        const dataGetbusy = await db.select('wxbaf03b7acb3c993a_sleep_station', {
            where: {
                unionid: this.unionid
            }
        })
        if (dataGetbusy.length > 0) {
            if (dataGetbusy[0].busy == 'true') {
                console.log('ç”¨æˆ·è¿˜åœ¨åŒ¹é…ä¸­ ç›´æ¥è¿”å› ä¸æ‰§è¡Œä»»ä½•ä»£ç ')
                return
            }

            if ( (parseInt(dataGetbusy[0].update) <= new Date().getTime() - 10800000) && dataGetbusy[0].exchange_unionid === 'none') {
                if (dataGetbusy[0].step == 0) {
                    return
                }
                this.updateStep(0)
                this.overTime()
                return
            }

        }

        /* await this.setUserBusyState('true')
        setTimeout(() => {
            this.setUserBusyState('false')
            console.log('ç”¨æˆ·é¢‘ç¹è¾“å…¥ï¼')
            sendTouser.sendMessage(this.open_id, `ä¸è¦é¢‘ç¹è¾“å…¥å“¦~`, this.token)
            return
        }, ) */

        const step = await this.getStep()

        switch (parseInt(step)) {
            case 0: {
                console.log('a' + this.key +  contentType + content )
                console.log(this.key !== content)
                console.log(contentType)
                console.log(contentType !== 'text')
                if (this.key !== content || contentType !== 'text') {
                    return
                }
                if (this.sex == 0) { // ä¸çŸ¥é“æ˜¯ç”·å¥³
                    sendTouser.sendMessage(this.open_id, `è¯·è¾“å…¥ä½ çš„æ€§åˆ«ï¼Œå›å¤'1'ä»£è¡¨ç”·ç”Ÿï¼Œå›å¤'2'ä»£è¡¨å¥³ç”Ÿ`)
                    this.updateStep(7)
                    return
                }

                await this.addUser()
                await this.start()
                await sendTouser.sendMessage(this.open_id, `è¯·å‘é€ä½ ä¸€æ®µå…³äºç¡çœ çš„è¯­éŸ³æ•…äº‹ç»™æˆ‘ä»¬ï¼Œæˆ‘ä»¬å°½å¿«å®Œæˆäº¤æ¢åŒ¹é…\r\n\r\nğŸ‘‰æ³¨æ„äº¤æ¢æ¬¡æ•°åªæœ‰ä¸€æ¬¡ï¼Œè¯·è®¤çœŸå¯¹å¾…`, this.token)
                this.updateStep(1)
            }
                break;
            case 1: {
                if (contentType !== 'voice') {
                    this.textErr('voice')
                    return
                }
                this.saveVoiceMediaId(mediaId) // ç›´æ¥ä¿å­˜ å› ä¸ºä¼šå–ä¸åˆ°é‚£ä¸ªidçš„
                this.textVerifySubmit('common')
                this.updateStep(2)
                    }
                break;
            case 2: {
                if (!this.verifyNumber(content, contentType)) {
                    return
                }
                if (content == 2) {
                    this.updateStep(1) // å›åˆ°è¯­éŸ³è¾“å…¥ é‡æ–°è¾“å…¥
                    this.changeMind()
                }
                if (content == 1) {
                    sendTouser.sendMessage(this.open_id, `æ˜¯å¦æœ‰å…³äºè¿™æ®µæ•…äº‹çš„é…å›¾ï¼Ÿ\r\n\r\næœ‰ï¼šè¯·ç›´æ¥å‘å›¾ç‰‡ç»™æˆ‘\r\næ²¡æœ‰è¯·è¾“å…¥ï¼š "æ²¡æœ‰å›¾ç‰‡"`, this.token)
                    this.updateStep(3)
                }
            }
                break;
            case 3: {
                if (content.indexOf('æ²¡æœ‰') == 0) {
                    await sendTouser.sendMessage(this.open_id, `æˆ‘ä»¬æ­£åœ¨ä¸ºä½ åŒ¹é… è¯·ç¨ç­‰å“¦`, this.token)
                    console.log('ç”¨æˆ·æ²¡æœ‰å›¾ç‰‡')
                    this.exchangeSuccess()
                    this.updateStep(5)
                    return
                }
                if (contentType !== 'image') {
                    this.textErr('picture')
                    return
                }
                this.textVerifySubmit('picture')
                this.savePicMediaId(mediaId)
                this.updateStep(4)
            }
                break;
            case 4: {
                if (!this.verifyNumber(content, contentType)) {
                    console.log('?? æˆ‘è§‰å¾—æ˜¯å‘äº†ä¸¤ä¸ªä¸œè¥¿ç»™æˆ‘å§ï¼Ÿï¼Ÿï¼Ÿ')
                    return
                }
                if (content == 1) {
                    await sendTouser.sendMessage(this.open_id, `æˆ‘ä»¬æ­£åœ¨ä¸ºä½ åŒ¹é… è¯·ç¨ç­‰å“¦`, this.token)
                    await this.exchangeSuccess()
                    this.updateStep(5)
                }
                if (content == 2) {
                    this.changeMind()
                    this.updateStep(3)
                }
            }
                break;
            case 5: {
                if (content === 'ä¸¾æŠ¥') {
                    console.log('è§¦å‘ç”¨æˆ·ä¸¾æŠ¥æœºåˆ¶')
                    sendTouser.sendMessage(this.open_id, `å·²æ”¶åˆ°ä½ çš„ä¸¾æŠ¥ï¼Œç»™ä½ å¸¦æ¥ç³Ÿç³•çš„å¿ƒæƒ…çœŸçš„å¾ˆä¸å¥½æ„æ€`, this.token)
                    this.end()
                    db.update('wxbaf03b7acb3c993a_sleep_station', {
                        step: '999'
                    }, {
                        where: {
                            unionid: this.unionid
                        }
                    })
                    return
                }

                if (contentType !== 'text') {
                    this.textErr('text')
                    return
                }
                await sendTouser.sendMessage(this.open_id, `è¯·è€å¿ƒç­‰å¾…å“¦`, this.token)
                await this.exchangeMessage('exchange_message_one', content)
            }
                break;
            case 6: { // è¿™ä¸€æ­¥æ˜¯ æœªçŸ¥ æ‰€ä»¥æ˜¯ç”·å¥³èµ‹å€¼

            }
                break;
            case 7: {
                if (!this.verifyNumber(content, contentType)) {
                    this.textErr('number')
                    return
                }
                this.updateStep(0)
            }
                break;
            case 8: {
                if (contentType !== 'text') {
                    this.textErr('text')
                    return
                }
                await sendTouser.sendMessage(this.open_id, `è¯·è€å¿ƒç­‰å¾…å“¦`, this.token)
                await this.exchangeMessage('exchange_message_two', content)
            }
                break;
            case 999: {
                /* await sendTouser.sendMessage(this.open_id, `æ—é‘«é‡æ–°è¾“å…¥å…¥èŒ å°±å¯ä»¥é‡æ–°ç©äº†`, this.token)
                db.delete('wxbaf03b7acb3c993a_sleep_station', {
                    unionid: this.unionid
                }) */

            }
                break;
        }

    }

    async start () {
        let data = await db.select('wxbaf03b7acb3c993a_sleep_station', {
            where: {
                unionid: this.unionid
            }
        })

        const dataPlatForm = await db.select('wxbaf03b7acb3c993a_appid_platform', {
            where: {
                appid: data[0].platform_id
            }
        })

        if (dataPlatForm[0] && dataPlatForm[0].qrcode_url) {
            this.QRblockUrl = dataPlatForm[0].qrcode_url
        }

        const initContent = `å˜¿ï¼Œ${this.nick_name}ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥æ‹¯æ•‘å¤±çœ çš„ä¸–ç•Œå§\r\n` +
            `è¿™é‡Œæ˜¯ ${myLink} ç”¨æ— æ•°ä¸ªå¤±çœ çš„å¤œæ™šè”åˆæ‰“é€ çš„ æ™šå®‰ç¡åŠ¡å±€\r\n\r\n` + // `è¿™é‡Œæ˜¯ ${myLink} x ${dataPlatForm[0].name} ç”¨æ— æ•°ä¸ªå¤±çœ çš„å¤œæ™šè”åˆæ‰“é€ çš„ æ™šå®‰ç¡åŠ¡å±€\r\n\r\n` +
            `ç¡å‰ï¼Œä½ çš„å¤§è„‘ä¼šæœ‰æ€ä¹ˆæ ·çš„ç‹‚æƒ³æ›²ï¼Ÿ
è¿˜æ˜¯ä¼šæœ‰ä¸€ä¸ªè¿·è¿·ç³Šç³Šçš„æ¢¦ï¼Ÿ
äº¦æˆ–è€…éå¸¸æœŸå¾…ä»Šæ™šèƒ½æœ‰äººå’Œä½ åˆ†äº«æˆ–å¼€å¿ƒæˆ–ä¸å¼€å¿ƒçš„äº‹æƒ…
æˆ–è€…ä»Šå¤©è¿‡å¾—ç¨å¾®æœ‰ç‚¹æ— è¶£ï¼Œä½†è¿˜æ˜¯æƒ³ç”¨ä¸€æ®µè¯­éŸ³ï¼Œæ¥å‘Šåˆ«ä»Šå¤©åŠªåŠ›çš„è‡ªå·±\r\n
ä¸ç®¡æ€æ ·ï¼Œç°åœ¨æŒ‰ä¸‹è¯­éŸ³é”®ï¼Œå½•ä¸‹ä½ çš„æ™šå®‰ï¼Œè·Ÿå¦ä¸€ä¸ªäººäº¤æ¢å§`
        await sendTouser.sendMessage(this.open_id, initContent, this.token)
    }

    changeMind () {
        sendTouser.sendMessage(this.open_id, `æ¥å§ï¼Œå¤§èƒ†ä¿®æ”¹ä½ çš„æƒ³æ³•å§`, this.token)
    }

    verifyNumber (content, contentType) {
        console.log(content, contentType)
        if (contentType !== 'text' || (parseInt(content) != 1 && parseInt(content) != 2)) {
            this.textErr('number')
            return false
        }
        return true
    }

    textErr (type) {
        switch (true) {
            case (type === 'voice'): sendTouser.sendMessage(this.open_id, `è¯·å›å¤è¯­éŸ³ï¼Œå¦åˆ™å°†æ— æ³•ç»§ç»­`, this.token)
                break;
            case (type === 'number'): sendTouser.sendMessage(this.open_id, `è¯·è¾“å…¥æ•°å­—â€˜1â€™ é‡æ–°è¾“å…¥å›å¤ â€˜2â€™`, this.token)
                break;
            case (type === 'picture'): sendTouser.sendMessage(this.open_id, `è¯·å›å¤å›¾ç‰‡ï¼Œå¦åˆ™å°†æ— æ³•ç»§ç»­ã€‚`, this.token)
                break;
            case (type === 'text'): sendTouser.sendMessage(this.open_id, `è¯·å›å¤æ–‡å­—ï¼Œæˆ‘ç›¸ä¿¡ä½ åªæ˜¯æ‰‹æŠ–ã€‚`, this.token)
                break;
        }
    }

    textVerifySubmit (type = 'common') {
        switch (true) {
            case (type === 'common'): sendTouser.sendMessage(this.open_id, `æ˜¯å¦ç¡®è®¤å‘é€è¯¥å†…å®¹\r\n\r\nç¡®è®¤å›å¤â€œ1â€ï¼Œé‡æ–°è¾“å…¥å›å¤â€œ2â€`, this.token)
                break;
            case (type === 'picture'): sendTouser.sendMessage(this.open_id, `æ˜¯å¦ç¡®è®¤å‘é€è¿™å¼ å›¾ç‰‡\r\n\r\nç¡®è®¤å›å¤â€œ1â€ï¼Œé‡æ–°è¾“å…¥å›å¤â€œ2â€`, this.token)
                break;
        }
    }

    overTime () {
        sendTouser.sendMessage(this.open_id, `ç”±äºä½ çš„æ“ä½œè¶…æ—¶ï¼Œç°å·²ç»“æŸä½ çš„äº¤æ¢æµç¨‹ï¼Œè¯·é‡æ–°è¾“å…¥${this.key}ï¼Œä»¥é‡æ–°è¿›è¡ŒåŒ¹é…ã€‚\r\n\r\næ›´å¤šæ´»åŠ¨è¯¦æƒ…è¯·å…³æ³¨\r\n${myLink}`, this.token)
    }

    async addUser () {
        const data = await db.select('wxbaf03b7acb3c993a_sleep_station', {
            where: {
                unionid: this.unionid
            }
        })
        if (data.length !== 0) {
            return 'fail'
        }
        await db.insert('wxbaf03b7acb3c993a_sleep_station', {
            unionid: this.unionid,
            nick_name: this.nick_name,
            sex: this.sex,
            exchange_unionid: 'none',
            exchange_message_one: 'none',
            exchange_message_two: 'none',
            pic_url: 'none',
            update: new Date().getTime(),
            platform_id: this.platform_id,
            busy: 'false',
            no_voice: this.open_id
        })
        return 'success'
    }

    updateUserTimeStamp () {
        db.update('wxbaf03b7acb3c993a_sleep_station', {
            update: new Date().getTime()
        })
    }

    updateStep (count) {
        if (count == 999) {
            db.update('wxbaf03b7acb3c993a_sleep_station', {
                step: count,
                busy: false
            }, {
                where: {
                    unionid: this.unionid
                }
            })
        } else {
            db.update('wxbaf03b7acb3c993a_sleep_station', {
                step: count
            }, {
                where: {
                    unionid: this.unionid
                }
            })
        }
    }

    async getStep () {
        const data = await db.select('wxbaf03b7acb3c993a_sleep_station', {
            where: {
                unionid: this.unionid
            }
        })

        return data.length === 0 ? 0 : data[0].step
    }

    savePicMediaId (mediaId) {
        console.log('ç”¨æˆ·è¦æ·»åŠ å›¾ç‰‡äº†' + mediaId)
        sendTouser.saveMediaResource(mediaId, this.unionid, this.token, '.jpeg')
        db.update('wxbaf03b7acb3c993a_sleep_station', {
            pic_mediaid: mediaId
        }, {
            where: {
                unionid: this.unionid
            }
        })
    }

    saveVoiceMediaId (mediaId) {
        console.log('ç”¨æˆ·è¦æ·»åŠ å£°éŸ³äº†' + mediaId)
        sendTouser.saveMediaResource(mediaId, this.unionid, this.token, '.mp3')
        db.update('wxbaf03b7acb3c993a_sleep_station', {
            voice_mediaid: mediaId
        }, {
            where: {
                unionid: this.unionid
            }
        })
    }

    async selectUser (time, sex) { // æ²¡æœ‰ç”¨æˆ·çš„æ—¶å€™çš„è§„åˆ™å¤„ç†
        let insertSex = undefined
        console.log(time + ' count times 5 ')
        if (time >= 12 * 3 && time < 12 * 3 * 2) {
            insertSex = randomNum(1,2)
        }

        if (time === 12 * 3 * 2) { // 12 * 3 * 2
            db.update('wxbaf03b7acb3c993a_sleep_station', {
                exchange_unionid: 'robot',
                step: '999'
            }, {
                where: {
                    unionid: this.unionid
                }
            })

            console.log('æ‰¾ä¸åˆ°ç”¨æˆ· æˆ‘ä»¬ä½¿ç”¨æœºå™¨äººå§')
            this.token = await refleashSelfAccessToken(this.platform_id)
            const sex = 2// this.sex === 1 ? 2 : 1 é»˜è®¤æ˜¯2äº†

            let files = fs.readdirSync(path.join(__dirname, `../robot/${sex}`))
            let maxCount = 0
            files.forEach((val,index) => {
                maxCount += 1
                console.log(val)
                console.log(index)
                console.log('?' + index)
            })
            console.log(maxCount)
            const getRobotName = JSON.parse(fs.readFileSync(path.join(__dirname, '../robotName.json')))
            const rN = randomNum(1, (maxCount - 1) / 2)
            console.log(getRobotName[rN])
            await sendTouser.sendMessage(this.open_id, `æ¥è‡ª ${myLink} çš„ @${getRobotName[rN]}\r\nä¸ä½ äº¤æ¢äº†ä¸€æ®µè¯­éŸ³å’Œå›¾ç‰‡`, this.token)
            await sendRawMediaData(this.open_id, this.token, 'image', 2, rN)
            await sendRawMediaData(this.open_id, this.token, 'voice', 2, rN)
            setTimeout(() => {
                sendTouser.sendMessage(this.open_id, `ä½ æœ‰ä¸¤æ¬¡æœºä¼šç»™@${getRobotName[rN]}ç•™è¨€æœºä¼šï¼Œè¯·å‘é€ã€æ–‡å­—æ¶ˆæ¯ã€‘ï¼Œå¯¹æ–¹å°†ä¼šæ”¶åˆ°\r\n(è¯·åœ¨15åˆ†é’Ÿä¹‹å†…ç•™è¨€)`, this.token)
            }, 5000)
            setTimeout(async () => {
                this.token = await refleashSelfAccessToken(this.platform_id)
                await sendTouser.sendMessage(this.open_id, `ä½ çš„åŒ¹é…å¯¹è±¡å·²ç¦»å¼€`, this.token)
                this.end()
            }, 60 * 1000 * 5) // 60 * 1000 * 5
            return
        }




        this.exchangeSuccess( time + 1, insertSex )


    }

    async exchangeSuccess (time = 1, sex = this.sex === 1 ? 2 : 1) {
        await db.update('wxbaf03b7acb3c993a_sleep_station', {
            busy: 'true'
        }, {
            where: {
                unionid: this.unionid
            }
        })

        let data = await db.select('wxbaf03b7acb3c993a_sleep_station', {
            where: {
                exchange_unionid: 'none',
                sex,
                step: 5
            },
            orders: [['update', 'desc']]
        })



        const data3 = await db.select('wxbaf03b7acb3c993a_sleep_station', {
            where: {
                exchange_unionid: this.unionid
            }
        })
        console.log(sex + 'ç”·å¥³ 1 2')
        if (data3.length > 0) {
            data[0] = data3[0]
        }

        if (data.length === 0) {
            setTimeout(() => {
                this.selectUser(time, sex)
            }, 5 * 1000)
            return
        }

        if (data[0].unionid === this.unionid) {
            console.log('åŒ¹é…åˆ°è‡ªå·±äº†')
            if (data.length < 2) {
                console.log('ç³Ÿç³• æ‰¾ä¸åˆ°äºº')
                setTimeout(() => {
                    this.selectUser(time, sex)
                }, 5 * 1000)
                return
            }
            data[0] = data[1]
        }



        await db.update('wxbaf03b7acb3c993a_sleep_station', {
            // exchange_unionid: data[0].unionid,
            busy: 'false'
        },{
            where: {
                unionid: this.unionid
            }
        })

        if (data3.length === 0) { // æ²¡æœ‰ æ²¡æœ‰çš„æ—¶å€™å»æ”¹å¯¹æ–¹çš„ä¸œè¥¿å°±å¥½äº†
            await db.update('wxbaf03b7acb3c993a_sleep_station', {
                exchange_unionid: this.unionid
            },{
                where: {
                    unionid: data[0].unionid
                }
            }) // updateå¯¹æ–¹çš„exchange_unionid

            // æˆ‘è§‰å¾—è¿™é‡Œ ä¸¤ä¸ªäººéƒ½å»updateå¯¹æ–¹çš„æ—¶å€™
            const cusor = await db.select('wxbaf03b7acb3c993a_sleep_station', {
                where: {
                    unionid: data[0].unionid
                }
            })

            if (cusor[0].exchange_unionid !== this.unionid) {
                console.log('åŒ¹é…çš„æ—¶å€™å†²çª é‡æ–°åŒ¹é…')

                this.exchangeSuccess(time, sex === 1 ? 2 : 1)
                return
            }


            await db.update('wxbaf03b7acb3c993a_sleep_station', { // æˆ‘è§‰å¾—æ˜¯æœ‰çš„è¯ å°±ä¿®æ”¹è‡ªå·±çš„exchange_id è¿™æ ·å°±è¶³å¤Ÿäº†å•Š
                exchange_unionid: data[0].unionid
            },{
                where: {
                    unionid: this.unionid
                }
            })
        } else {

        }

        db.update('wxbaf03b7acb3c993a_sleep_station', {
            busy: 'false'
        },{
            where: {
                unionid: this.unionid
            }
        })


        const dataPlatForm = await db.select('wxbaf03b7acb3c993a_appid_platform', {
            where: {
                appid: data[0].platform_id
            }
        })
        console.log('ä¸ºç”¨æˆ·æ‰¾åˆ°åŒ¹é…ï¼' + data[0].nick_name)
        this._oppsiteName = data[0].nick_name
        this._oppsiteUnionId = data[0].unionid

        await sendTouser.sendMessage(this.open_id, `æ¥è‡ª ${dataPlatForm[0].name} çš„ @${data[0].nick_name}\r\nä¸ä½ äº¤æ¢äº†ä¸€æ®µè¯­éŸ³å’Œå›¾ç‰‡`, this.token)

        /* if (this.platform_id !== data[0].appid) {

        } else {
            console.log('åŒå¹³å°å‘é€')
            if (data[0].pic_mediaid) {
                await sendTouser.sendMediaContent(this.open_id, data[0].pic_mediaid, this.token, 'image')
            }
            await sendTouser.sendMediaContent(this.open_id, data[0].voice_mediaid, this.token, 'voice')
        }
        console.log('ä¸åŒå¹³å°çš„å‘é€') */

        if (data[0].pic_mediaid) {
            await sendMediaData(this.open_id, this.token, 'image', data[0].unionid)
        }
        await sendMediaData(this.open_id, this.token, 'voice', data[0].unionid)

        await sendTouser.sendMessage(this.open_id, `ï¼ˆæç¤ºï¼šå¦‚æœå¯¹æ–¹çš„äº¤æ¢å«æœ‰è®©ä½ ä¸æ‚¦çš„å†…å®¹ï¼Œæˆ–æ²¡æœ‰æŒ‰è§„åˆ™å‚åŠ ï¼Œå¯å›å¤â€œä¸¾æŠ¥â€ï¼‰`, this.token)
        await sendTouser.sendMessage(this.open_id, `ä½ æœ‰ä¸¤æ¬¡æœºä¼šç»™@${this._oppsiteName}ç•™è¨€æœºä¼šï¼Œè¯·å‘é€æ¶ˆæ¯ï¼Œå¯¹æ–¹å°†ä¼šæ”¶åˆ°\r\n\r\nğŸ³\r\n\r\nå‘åˆ°è¿™é‡Œï¼Œå¯¹æ–¹å°†ä¼šç«‹åˆ»æ”¶åˆ°\r\n\r\n[æœˆäº®](15åˆ†é’Ÿå†…ç•™è¨€æœ‰æ•ˆ)`, this.token)

        // åŒ¹é…æˆåŠŸä¹‹å å°±å¯ä»¥è¿›å…¥æ–°çš„è®¡æ—¶å™¨äº†
        setTimeout(async () => {
            this.token = await refleashSelfAccessToken(this.platform_id)
            const dataGetbusy = await db.select('wxbaf03b7acb3c993a_sleep_station', {
                where: {
                    unionid: this.unionid
                }
            })
            if ( dataGetbusy[0].exchange_message_one === 'none' && parseInt(dataPlatForm[0].step) !== 999) { // åŒ¹é…å®Œæˆå ä½ çš„ç¬¬ä¸€æ¡ç•™è¨€è¿˜æ˜¯none é‚£ä¹ˆæˆ‘ä»¬å°±Tä½ å‡ºå±€
                this.updateStep(999)
                await sendTouser.sendMessage(this.open_id, `ä½ çš„åŒ¹é…å¯¹è±¡å·²ç¦»å¼€`, this.token)
                this.end()
                return
            }
        }, 1000 * 60 * 15)


    }

    async exchangeMessage (messageSite, content) {
        // æ›´æ–°æœ¬åœ°çš„exchange_message ä¿¡æ¯
        await db.update('wxbaf03b7acb3c993a_sleep_station', {
            [messageSite]: content,
            busy: 'true'
        }, {
            where: {
                unionid: this.unionid
            }
        })

        const mydata = await db.select('wxbaf03b7acb3c993a_sleep_station', {
            where: {
                unionid: this.unionid
            }
        })
        const data = await db.select('wxbaf03b7acb3c993a_sleep_station', {
            where: {
                unionid: mydata[0].exchange_unionid
            }
        })
        const platFormData = await db.select('wxbaf03b7acb3c993a_appid_platform', {
            where: {
                appid: data[0].platform_id
            }
        })

        sendTouser.sendMessage(data[0].no_voice, `@${mydata[0].nick_name} æ”¶åˆ°ä½ çš„ä¿¡æ¯åï¼Œç»™ä½ ç•™äº†ä¸€æ®µè¯\r\n\r\n${content}`, platFormData[0].authorization_access_token)
        this.getTheirMessage(messageSite, 1, content)
    }

    async getTheirMessage (messageSite, times = 1, content) {
        const mydata = await db.select('wxbaf03b7acb3c993a_sleep_station', {
            where: {
                unionid: this.unionid
            }
        })

        const data = await db.select('wxbaf03b7acb3c993a_sleep_station', {
            where: {
                unionid: mydata[0].exchange_unionid
            }
        })

        // 2019.1.30 ä¸ºå¯¹æ–¹ç«‹åˆ»å‘é€ç•™è¨€
        // this.sendMessageImmediately(data[0].no_voice, content)

        /* if (mydata[0].busy === 'true') {
            return
        } */

        if (data[0][messageSite] === 'none') {
            console.log('å¯¹æ–¹æ²¡æœ‰ç»™ä½ ç•™è¨€å“¦')
            if (times >= 12 * 3 * 5) { // 15åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡æœºåˆ¶
                sendTouser.sendMessage(this.open_id, `ä½ çš„åŒ¹é…å¯¹è±¡å·²ç¦»å¼€`, this.token)
                this.end()
                this.updateStep(999)
                return
            }
            setTimeout(() => {
                this.getTheirMessage(messageSite, times + 1)
            }, 1000 * 5) // 3åˆ†é’Ÿè¯¢é—®
            return
        } else {
            // 2019.1.30 ä¿®æ”¹ä¸ºinterval xia
            // await sendTouser.sendMessage(this.open_id, `@${data[0].nick_name} æ”¶åˆ°ä½ çš„æ–‡å­—åï¼Œç»™ä½ ç•™äº†ä¸€æ®µè¯\r\n\r\n${data[0][messageSite]}`, this.token)
            db.update('wxbaf03b7acb3c993a_sleep_station', {
                busy: false
            }, {
                where: {
                    unionid: this.unionid
                }
            })
            if (messageSite === 'exchange_message_one') {
                sendTouser.sendMessage(this.open_id, `è¿™æ˜¯ä½ æœ€åä¸€æ¬¡ç•™è¨€æœºä¼šï¼Œè¯·è®¤çœŸå›å¤ã€‚\r\n\r\nå¦‚æœä½ è§‰å¾—å¯¹æ–¹æ˜¯ä¸ªæœ‰è¶£çš„äººï¼Œä¸å¦¨ç•™ä¸‹ä½ çš„å¾®ä¿¡
æˆ–è€…ä½ æƒ³æœ€åå‘Šè¯‰ä»–ï¼Œå…³äºè¿™æ®µæ•…äº‹ï¼Œä½ æœ‰ä»€ä¹ˆçœ‹æ³•`, this.token)
                // åŒ¹é…æˆåŠŸä¹‹å å°±å¯ä»¥è¿›å…¥æ–°çš„è®¡æ—¶å™¨äº†
                setTimeout(async () => {
                    const dataGetbusy = await db.select('wxbaf03b7acb3c993a_sleep_station', {
                        where: {
                            unionid: this.unionid
                        }
                    })
                    if ( dataGetbusy[0].exchange_message_two === 'none' ) { // ä½ è¿˜æ²¡æœ‰å‘å‡ºç¬¬äºŒæ¡çš„æ—¶å€™ ä¹Ÿä¼šTä½ å‡ºå±€
                        this.token = await refleashSelfAccessToken(this.platform_id)
                        console.log(`${dataGetbusy[0].busy} çœ‹çœ‹busy`)
                        console.log(`${dataGetbusy[0].unionid} çœ‹çœ‹unionid`)
                        console.log(`${dataGetbusy[0].step} çœ‹çœ‹step`)
                        this.updateStep(999)
                        console.log('ç”¨æˆ·è¶…æ—¶æ“ä½œ')
                        await sendTouser.sendMessage(this.open_id, `ä½ çš„åŒ¹é…å¯¹è±¡å·²ç¦»å¼€`, this.token)
                        this.end()
                        return
                    }
                }, 1000 * 60 * 15)
                this.updateStep(8)
            } else {
                this.end()
                this.updateStep(999)
            }
            return
        }
    }

    sendMessageImmediately (oppsiteOpenId, message) {
        console.log('ç«‹åˆ»äº¤æ¢ä¿¡æ¯' + oppsiteOpenId + message)
        sendTouser.sendMessage(oppsiteOpenId, message, this.token)
    }

    async end () {
        const data = await db.select('wxbaf03b7acb3c993a_sleep_station', {
            where: {
                unionid: this.unionid
            }
        })

        // await sendTouser.getMediaPic('æè¿°', this.token, this.open_id, null, this.platform_id, 3, this.nick_name, this.pic_url) // å›¾ç‰‡
        // await sendTouser.sendMessage(this.open_id, `äº¤æ¢ç»“æŸï¼ŒèŒä½ç”³è¯·æˆåŠŸï¼Œæ„Ÿè°¢ä½ ä»Šæ™šçš„ç›¸ä¼´\r\n\r\næ­å–œä½ å·²è·å¾— <a href='http://mp.weixin.qq.com/s?__biz=MzI2MTQzMjAwMA==&mid=100001424&idx=1&sn=b4150dfa72d5765e9907ff02989fe85b&chksm=6a5b313f5d2cb829cd5c5fe7b410a2cc7e64ddfae8a11b4cc667c1dfb2ce9f9274d9265a7d57#rd'>æ™šå®‰ç¡åŠ¡å±€</a> è®¤è¯çš„ç¡åŠ¡å‘˜ä¸€èŒï¼Œä½ çš„ç¼–å·æ˜¯${data[0].id}\r\næ„Ÿè°¢å‚ä¸æœ¬æ¬¡æ´»åŠ¨ï¼Œåœ¨ä¸‹ä¸ªæ˜ŸæœŸï¼Œæˆ‘ä»¬å°†ä¼šå…¬å¸ƒç¡åŠ¡å‘˜çš„å…·ä½“ä»»åŠ¡ï¼Œè¯·å¦¥å–„ä¿å­˜`, this.token)
        await sendTouser.sendMessage(this.open_id, `äº¤æ¢æ´»åŠ¨ç»“æŸï¼Œæ„Ÿè°¢ä½ ç²¾å¿ƒåˆ†äº«çš„æ•…äº‹å’Œä»Šæ™šçš„ç›¸ä¼´

æ„Ÿè°¢å‚ä¸æœ¬æ¬¡æ´»åŠ¨ï¼Œä½ çš„æ™šå®‰ç¡å‰æ•…äº‹å°†ä¼šè¢«æ”¶å½•è¿›\r\n\r\n <a  class="weapp_text_link" style="font-size:17px;" data-miniprogram-appid="wxf9e01cdca4779ccb" data-miniprogram-path="pages/welcome/welcome" data-miniprogram-nickname="å°ç¡çœ " href="" data-miniprogram-type="text" data-miniprogram-servicetype=""'>å°ç¡çœ Â·æ™šå®‰ç¡åŠ¡å±€</a>

æ„¿ä½ ä»Šæ™šåšä¸ªå¥½æ¢¦ã€‚`, this.token)

        /* fs.exists(path.join(path.join(__dirname, '../tz/123' +'.png'), (exists) => {
            if (exists) {
                sendTouser.sendMessage(this.open_id, ':) yep', this.token)
            } else {
                sendTouser.sendMessage(this.open_id, ':) ye p', this.token)
            }
        }))

        const a = await sleepStationPic(this.nick_name, this.QRblockUrl, (desc) => {
            sendTouser.sendMessage(this.open_id, desc, this.token)
        }) */
            // sendMediaData(this.open_id, this.token, 'png', 'hodor')

        /* const dataPlatForm = await db.select('wxbaf03b7acb3c993a_appid_platform', {
            where: {
                appid: this.platform_id
            }
        }) */

        const a = await sleepStationPic(this.nick_name, 'http://mmbiz.qpic.cn/mmbiz_jpg/wib5vLMkeLaPiaHQVFZQrUNBVDoEPsQOicrTnR7piczDWbuSlYIfIow1hTibIvMszfeQAmk0KWa66aHEWtqqAOheexA/0', ('' + data[0].id).padStart(6, 0), this.platform_id)

        sendMediaDataCopy(this.open_id, this.token, 'image', a)
        // await sendRawMediaData(this.open_id, this.token, 'image', 2, 2)
        // sendTouser.sendMessage(this.open_id, `æ¬¡æ´»åŠ¨å°†åœ¨æ˜å¤©æ™šä¸Š12ç‚¹ç»“æŸï¼Œå¸Œæœ›ä½ èƒ½å¸®å¿™æŠŠèŒåŠ¡å¡åˆ†äº«åˆ°æœ‹å‹åœˆä¸­ï¼Œä»¥ä¾¿æˆ‘ä»¬æ›´å¿«åœ°æ‰¾åˆ°åˆé€‚çš„ç¡åŠ¡å‘˜ï¼Œä¸€èµ·å»å¹²æ‰å¤±çœ å¸¦æ¥çš„ç„¦è™‘ã€ä¸å®‰ä¸å­¤ç‹¬`, this.token)
    }

    async robotSendData () {
        await sendMediaData(this.open_id, this.token, 'image', data[0].unionid)
    }

}


function randomNum (minNum, maxNum) {
    switch (arguments.length) {
        case 1:
            return parseInt(Math.random() * minNum + 1, 10)
        case 2:
            return parseInt(Math.random() * (maxNum - minNum + 1) + minNum, 10)
        default:
            return 0
    }
}

async function sendMediaData (openid, token, type = 'iamge', hashPicName) { // 465
    return new Promise((resolve) => {
        let formData = {
            my_field: 'my_value',
            my_file:  fs.createReadStream(path.join(__dirname, `../userExchangeSleepStation/${hashPicName}.${type == 'image' ? 'jpeg' : 'mp3' }`))
        }
        request.post({url:`https://api.weixin.qq.com/cgi-bin/media/upload?access_token=${token}&type=${type}`, formData: formData}, async function(err, httpResponse, body) {
            if (err) {
                return console.error('upload failed:', err)
            }
            console.log(body)
            console.log('ä¸Šä¼ æˆåŠŸ')
            await sendTouser.sendMediaContent(openid, JSON.parse(body).media_id, token, type)
            resolve()
        })
    })
}

async function sendMediaDataCopy (openid, token, type = 'iamge', hashPicName) { // 465
    return new Promise((resolve) => {
        let formData = {
            my_field: 'my_value',
            my_file:  fs.createReadStream(path.join(__dirname, `../tz/${hashPicName}.png`))
        }
        request.post({url:`https://api.weixin.qq.com/cgi-bin/media/upload?access_token=${token}&type=${type}`, formData: formData}, async function(err, httpResponse, body) {
            if (err) {
                return console.error('upload failed:', err)
            }
            console.log(body)
            console.log('ä¸Šä¼ æˆåŠŸ')
            await sendTouser.sendMediaContent(openid, JSON.parse(body).media_id, token, type)
            resolve()
        })
    })
}

async function sendRawMediaData (openid, token, type = 'iamge', sex, hashPicName) { // å«æœ‰Pathçš„
    return new Promise((resolve) => {
        let formData = {
            my_field: 'my_value',
            my_file:  fs.createReadStream(path.join(__dirname, `../robot/${sex}/${hashPicName}.${type == 'image' ? 'jpg' : 'mp3' }`))
        }
        request.post({url:`https://api.weixin.qq.com/cgi-bin/media/upload?access_token=${token}&type=${type}`, formData: formData}, async function(err, httpResponse, body) {
            if (err) {
                return console.error('upload failed:', err)
            }
            console.log('ä¸Šä¼ æˆåŠŸ')
            console.log(body)
            await sendTouser.sendMediaContent(openid, JSON.parse(body).media_id, token, type)
            resolve()
        })
    })
}

function randomNum (minNum, maxNum) {
    switch (arguments.length) {
        case 1:
            return parseInt(Math.random() * minNum + 1, 10)
        case 2:
            return parseInt(Math.random() * (maxNum - minNum + 1) + minNum, 10)
        default:
            return 0
    }
}

async function refleashSelfAccessToken (platFormId) { // 15åˆ†é’Ÿç­‰åœºæ™¯ å¯èƒ½ä¼šå‡ºç°çš„é—®é¢˜ æ‰€ä»¥è¿˜æ˜¯åˆ·æ–°ä¸‹Tokenäº†
    const data = await db.select('wxbaf03b7acb3c993a_appid_platform', {
        where: {
            appid: platFormId
        }
    })
    return data[0].authorization_access_token
}

module.exports = SleepStation
// wxbaf03b7acb3c993a_sleep_station
// unionid  exchange_unionid exchange_message_one exchange_message_two  nick_name sex update id(è®°å½•ç©çš„å…ˆåé¡ºåº) platform_id  step(è®°å½•ç©çš„æ­¥éª¤ ç®€ç§°æ­¥æ•°è®°å½•å§ é»˜è®¤æ˜¯0)
